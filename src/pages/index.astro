---
import { getCollection } from 'astro:content';
import Color from 'colorjs.io';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import FormattedDate from '../components/FormattedDate.astro';

const posts = (await getCollection('post'))
  .filter(
    (post) => !post.data.draft || (post.data.draft && import.meta.env.DEV),
  ) // draft는 개발 환경에서만 표시
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postColors = posts.map((post) => {
  // 색상 정의
  const lightStart = new Color('lab(63 59.32 -1.47)');
  const lightEnd = new Color('lab(33 42.09 -43.19)');
  const lightRange = lightStart.range(lightEnd);
  const darkStart = new Color('lab(81 32.36 -7.02)');
  const darkEnd = new Color('lab(78 19.97 -36.75)');
  const darkRange = darkStart.range(darkEnd);
  // 각 포스트의 색상 계산
  const today = new Date();
  // 첫 포스트 날짜
  const firstPostDate = new Date(2024, 9, 28); // 2024년 10월 28일, js는 월을 0부터 시작함
  const timeSinceFirstPost = today.getTime() - firstPostDate.getTime();
  const timeSinceThisPost =
    today.getTime() - new Date(post.data.pubDate).getTime();
  const staleness = timeSinceThisPost / timeSinceFirstPost;
  return {
    light: lightRange(staleness).toString(),
    dark: darkRange(staleness).toString(),
  };
});

// 스태거 클래스 (최대 10개까지, 이후는 마지막 값 유지)
const getStaggerClass = (index: number) => {
  const staggerIndex = Math.min(index + 1, 10);
  return `stagger-${staggerIndex}`;
};
---

<html lang="ko">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body class="mx-auto max-w-2xl bg-[--bg] px-5 py-14 text-[--text]">
    <Header isGradation={false} />
    <main>
      <section>
        <ul class="flex flex-col gap-10">
          {
            posts.map((post, index) => (
              <li class={`animate-fade-in-up ${getStaggerClass(index)}`}>
                <article>
                  <a
                    href={`/post/${post.slug}`}
                    class="post-item group block"
                  >
                    <h2
                      class="mb-1.5 text-[1.625rem] font-bold leading-snug tracking-tight"
                      style={`
                        --lightLink: ${postColors[index].light};
                        --darkLink: ${postColors[index].dark};
                        color: var(--lightLink);
                      `}
                    >
                      {post.data.title}
                      {post.data.draft && import.meta.env.DEV && (
                        <span class="ml-2 inline-block rounded bg-amber-100 px-1.5 py-0.5 align-middle text-xs font-medium text-amber-700">
                          초안
                        </span>
                      )}
                    </h2>
                    <time class="block text-[0.8rem] font-medium tracking-wide text-[--text-muted]">
                      <FormattedDate date={new Date(post.data.pubDate)} />
                    </time>
                    <p class="mt-2 text-[0.95rem] leading-relaxed text-[--text] opacity-80">
                      {post.data.description}
                    </p>
                  </a>
                </article>
              </li>
            ))
          }
        </ul>
      </section>
    </main>

    <footer class="mt-20 animate-fade-in-up stagger-10 border-t border-[--hr] pt-8 text-center text-[0.8rem] text-[--text-muted]">
      <p>&copy; {new Date().getFullYear()} Zettalyst. All rights reserved.</p>
    </footer>
  </body>
</html>

<style>
  @media (prefers-color-scheme: dark) {
    h2 {
      color: var(--darkLink) !important;
    }
  }
</style>
